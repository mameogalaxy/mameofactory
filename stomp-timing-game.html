<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>連続踏みつけタイミングゲーム</title>
    <style>
        body { margin: 0; padding: 20px; background: #222; color: #fff; font-family: Arial; text-align: center; }
        canvas { border: 2px solid #fff; background: linear-gradient(to bottom, #87CEEB, #98FB98); }
        #info { font-size: 20px; margin: 10px; }
    </style>
</head>
<body>
    <h1>連続踏みつけタイミングゲーム</h1>
    <div id="info">スコア: <span id="score">0</span> | 連続回数: <span id="combo">0</span> | 最高記録: <span id="maxCombo">0</span></div>
    <canvas id="game" width="800" height="600"></canvas>
    <p>スペース: ジャンプ | 矢印キー: 移動 | 同じ敵を連続で踏みつけろ！3秒以内に次を踏め！</p>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        
        // プレイヤー
        const player = { 
            x: 100, y: 450, width: 40, height: 40, 
            vx: 0, vy: 0, speed: 5, jumpPower: 15,
            onGround: false, canDoubleJump: false
        };
        
        // 敵（1体のみ）
        let enemy = null;
        let stompCount = 0;
        let lastStompTime = 0;
        let timeLimit = 3000; // 3秒以内に次の踏みつけ
        
        // 重力
        const gravity = 0.8;
        const groundY = 500;
        
        // キー入力
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'Space') {
                e.preventDefault();
                if (player.onGround) {
                    player.vy = -player.jumpPower;
                    player.onGround = false;
                    player.canDoubleJump = true;
                } else if (player.canDoubleJump) {
                    player.vy = -player.jumpPower * 0.8;
                    player.canDoubleJump = false;
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });
        
        // 敵生成
        function spawnEnemy() {
            enemy = {
                x: 300 + Math.random() * 200,
                y: groundY - 40,
                width: 40,
                height: 40,
                bounceHeight: 0,
                bounceSpeed: 0,
                color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                baseY: groundY - 40
            };
            stompCount = 0;
            lastStompTime = Date.now();
        }
        
        // 衝突判定
        function collision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }
        
        // 踏みつけ判定
        function isStomping(player, enemy) {
            return player.vy > 0 && 
                   player.y + player.height - 15 < enemy.y + enemy.bounceHeight &&
                   collision({
                       x: player.x,
                       y: player.y,
                       width: player.width,
                       height: player.height
                   }, {
                       x: enemy.x,
                       y: enemy.y + enemy.bounceHeight,
                       width: enemy.width,
                       height: enemy.height
                   });
        }
        
        // 更新
        function update() {
            // プレイヤー移動
            if (keys['ArrowLeft']) player.vx = -player.speed;
            else if (keys['ArrowRight']) player.vx = player.speed;
            else player.vx *= 0.8;
            
            // 重力適用
            player.vy += gravity;
            
            // プレイヤー位置更新
            player.x += player.vx;
            player.y += player.vy;
            
            // 画面端制限
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            
            // 地面判定
            if (player.y + player.height >= groundY) {
                player.y = groundY - player.height;
                player.vy = 0;
                player.onGround = true;
                player.canDoubleJump = false;
            }
            
            // 敵がいない場合は生成
            if (!enemy) {
                spawnEnemy();
            }
            
            // 敵更新
            if (enemy) {
                // バウンス効果
                enemy.bounceHeight += enemy.bounceSpeed;
                enemy.bounceSpeed += 0.5;
                if (enemy.bounceHeight >= 0) {
                    enemy.bounceHeight = 0;
                    enemy.bounceSpeed = 0;
                }
                
                // 踏みつけ判定
                if (isStomping(player, enemy)) {
                    stompCount++;
                    combo = stompCount;
                    score += 100 * stompCount;
                    lastStompTime = Date.now();
                    
                    // プレイヤーを跳ね返す
                    player.vy = -player.jumpPower * 0.8;
                    
                    // 敵をバウンスさせる
                    enemy.bounceSpeed = -8 - stompCount;
                    
                    if (stompCount > maxCombo) {
                        maxCombo = stompCount;
                        document.getElementById('maxCombo').textContent = maxCombo;
                    }
                    
                    document.getElementById('score').textContent = score;
                    document.getElementById('combo').textContent = combo;
                }
                
                // 時間切れチェック
                if (Date.now() - lastStompTime > timeLimit && stompCount > 0) {
                    alert(`時間切れ！\n連続踏みつけ回数: ${stompCount}\nスコア: ${score}`);
                    enemy = null;
                    stompCount = 0;
                    combo = 0;
                    document.getElementById('combo').textContent = combo;
                }
            }
        }
        
        // ゲームリセット
        function resetGame() {
            score = 0;
            combo = 0;
            stompCount = 0;
            player.x = 100;
            player.y = 450;
            player.vx = 0;
            player.vy = 0;
            player.onGround = false;
            enemy = null;
            document.getElementById('score').textContent = score;
            document.getElementById('combo').textContent = combo;
        }
        
        // 描画
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 地面描画
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
            
            // プレイヤー描画
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // 目を描画
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(player.x + 8, player.y + 8, 8, 8);
            ctx.fillRect(player.x + 24, player.y + 8, 8, 8);
            ctx.fillStyle = '#000000';
            ctx.fillRect(player.x + 10, player.y + 10, 4, 4);
            ctx.fillRect(player.x + 26, player.y + 10, 4, 4);
            
            // 敵描画
            if (enemy) {
                const drawY = enemy.y + enemy.bounceHeight;
                
                // 敵本体
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, drawY, enemy.width, enemy.height);
                
                // 敵の目
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(enemy.x + 8, drawY + 8, 8, 8);
                ctx.fillRect(enemy.x + 24, drawY + 8, 8, 8);
                ctx.fillStyle = '#000000';
                ctx.fillRect(enemy.x + 10, drawY + 10, 4, 4);
                ctx.fillRect(enemy.x + 26, drawY + 10, 4, 4);
                
                // 踏みつけ回数表示
                if (stompCount > 0) {
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(stompCount.toString(), enemy.x + 20, drawY - 10);
                }
                
                // 残り時間バー
                if (stompCount > 0) {
                    const timeLeft = Math.max(0, timeLimit - (Date.now() - lastStompTime));
                    const barWidth = (timeLeft / timeLimit) * 100;
                    
                    ctx.fillStyle = timeLeft < 1000 ? '#ff0000' : '#00ff00';
                    ctx.fillRect(enemy.x - 10, drawY - 30, barWidth, 8);
                    ctx.strokeStyle = '#ffffff';
                    ctx.strokeRect(enemy.x - 10, drawY - 30, 100, 8);
                }
            }
            
            // 連続踏みつけ表示
            if (stompCount > 0) {
                ctx.fillStyle = '#ffff00';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${stompCount}回連続！`, canvas.width / 2, 100);
                
                // 励ましメッセージ
                if (stompCount >= 10) {
                    ctx.fillStyle = '#ff00ff';
                    ctx.font = 'bold 24px Arial';
                    ctx.fillText('すごい！', canvas.width / 2, 130);
                } else if (stompCount >= 5) {
                    ctx.fillStyle = '#00ffff';
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText('いいぞ！', canvas.width / 2, 130);
                }
            }
        }
        
        // ゲームループ
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        gameLoop();
    </script>
</body>
</html>