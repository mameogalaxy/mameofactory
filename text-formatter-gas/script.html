<script>
let video,canvas,ctx;
let detector=null,score=0,currentStage=1,totalSquats=0,dailyTotal=0;
let headState='above',belowSince=0,noseHistory=[],maxDepthY=0;
let isTransitioning=false;
let lastDate=new Date().toDateString();
let faceDetected=false;
let playerLevel=1,playerExp=0;
let lastTreasureCheck=0;
let playStartTime=0,playTimeInterval=null;

function getExpForLevel(level){
  return Math.floor(10*Math.pow(1.5,level-1));
}

function addExp(amount){
  playerExp+=amount;
  let leveledUp=false;
  let overflowExp=0;
  
  while(playerExp>=getExpForLevel(playerLevel)&&playerLevel<100){
    overflowExp=playerExp-getExpForLevel(playerLevel);
    playerExp=getExpForLevel(playerLevel);
    updateExpUI();
    leveledUp=true;
    
    setTimeout(()=>{
      playerLevel++;
      playerExp=0;
      updateExpUI();
      showLevelUp();
      
      setTimeout(()=>{
        if(playerLevel>=100){
          playerLevel=100;
          playerExp=0;
        }else{
          playerExp=overflowExp;
        }
        updateExpUI();
        localStorage.setItem('playerLevel',playerLevel);
        localStorage.setItem('playerExp',playerExp);
      },100);
    },300);
    break;
  }
  
  if(!leveledUp){
    updateExpUI();
    localStorage.setItem('playerLevel',playerLevel);
    localStorage.setItem('playerExp',playerExp);
  }
}

function updateExpUI(){
  const needed=getExpForLevel(playerLevel);
  const percent=Math.min((playerExp/needed)*100,100);
  const remaining=Math.max(needed-playerExp,0);
  document.getElementById('expFill').style.width=percent+'%';
  if(playerLevel>=100){
    document.getElementById('expText').textContent='MAX LEVEL';
  }else{
    document.getElementById('expText').textContent='あと'+remaining+'EXP';
  }
  document.getElementById('levelInfo').textContent='Lv.'+playerLevel;
}

function playLevelUpSound(){
  try{
    const audioContext=new(window.AudioContext||window.webkitAudioContext)();
    const notes=[523.25,659.25,783.99,1046.50];
    const times=[0,0.08,0.16,0.24];
    
    notes.forEach((freq,i)=>{
      const oscillator=audioContext.createOscillator();
      const gainNode=audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.type='sine';
      oscillator.frequency.setValueAtTime(freq,audioContext.currentTime+times[i]);
      
      gainNode.gain.setValueAtTime(0,audioContext.currentTime+times[i]);
      gainNode.gain.linearRampToValueAtTime(0.2,audioContext.currentTime+times[i]+0.02);
      gainNode.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+times[i]+0.3);
      
      oscillator.start(audioContext.currentTime+times[i]);
      oscillator.stop(audioContext.currentTime+times[i]+0.3);
    });
  }catch(e){console.log('Sound error:',e);}
}

function showLevelUp(){
  playLevelUpSound();
  
  const levelUpEl=document.getElementById('levelUpEffect');
  if(!levelUpEl){
    const el=document.createElement('div');
    el.id='levelUpEffect';
    el.style.position='fixed';
    el.style.bottom='100px';
    el.style.left='20px';
    el.style.width='120px';
    el.style.textAlign='center';
    el.style.fontSize='2rem';
    el.style.fontWeight='900';
    el.style.fontFamily='Impact,sans-serif';
    el.style.color='#FFD700';
    el.style.textShadow='0 0 20px #FFD700,0 0 40px #FFA500,3px 3px 0 #000,-3px -3px 0 #000,3px -3px 0 #000,-3px 3px 0 #000';
    el.style.zIndex='102';
    el.style.opacity='0';
    el.style.transform='scale(0.5)';
    el.style.transition='all 0.3s';
    el.style.animation='sparkle 1.5s ease-in-out';
    el.textContent='LV UP!';
    document.body.appendChild(el);
    const style=document.createElement('style');
    style.textContent='@keyframes sparkle{0%,100%{opacity:0;transform:scale(0.5)}20%{opacity:1;transform:scale(1.3)}50%{opacity:1;transform:scale(1)}80%{opacity:1;transform:scale(1.1)}}';
    document.head.appendChild(style);
  }
  const el=document.getElementById('levelUpEffect');
  el.style.animation='none';
  setTimeout(()=>{
    el.style.animation='sparkle 1.5s ease-in-out';
  },10);
  setTimeout(()=>{
    el.style.opacity='0';
    el.style.transform='scale(0.5)';
  },1500);
}

const enemyNames=["アイスモッチ","ゴブリン","コウモリ","オオカミ","パンプキンナイト","ゾンビ","オーク","トロール","ワイバーン","ミノタウロス","バンシー","ガーゴイル","ケルベロス","ヒドラ","キマイラ","グリフォン","マンティコア","バジリスク","クラーケン","フェンリル","ダークナイト","デスナイト","ブラッドロード","シャドウデーモン","フロストジャイアント","フレイムタイタン","ストームドレイク","ヴァンパイアロード","リッチキング","アビスウォーカー","カオスビースト","ヴォイドスピリット","ダークエンペラー","インフェルノデーモン","グレイシャルドラゴン","サンダーコロッサス","ネクロマンサー","デモンロード","エンシェントドラゴン","アポカリプスナイト","破壊神ベヒーモス","冥界王ハデス","魔神アスモデウス","終焉竜ニーズヘッグ","混沌神カオス","絶対神ゼウス","創造神ブラフマー","破滅神シヴァ","全知全能オーディン","究極神アルティメット"];
const enemyMonsterImage=new Image();
enemyMonsterImage.src='https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/original/アイスモッチ.png';
const targetColors=["#90EE90","#8B4513","#4B0082","#696969","#F5F5DC","#556B2F","#8B0000","#2F4F4F","#9370DB","#8B4513","#E6E6FA","#708090","#8B0000","#006400","#FF4500","#DAA520","#8B008B","#228B22","#000080","#4B0082","#2F4F4F","#191970","#8B0000","#4B0082","#4682B4","#FF4500","#4169E1","#8B0000","#000000","#1C1C1C","#8B008B","#483D8B","#2F4F4F","#FF0000","#00CED1","#FFD700","#4B0082","#8B0000","#FF8C00","#000000","#8B4513","#4B0082","#8B0000","#006400","#4B0082","#FFD700","#FF4500","#8B0000","#0000CD","#FF00FF"];
let currentEnemyIndex=0;

function getStageGoal(s){return 5+(s-1)*2}

function startGame(){
  if(!video||!canvas||!ctx){
    video=document.getElementById('video');
    canvas=document.getElementById('overlay');
    ctx=canvas.getContext('2d');
  }
  totalSquats=0;
  currentEnemyIndex=(currentStage-1)%enemyNames.length;
  document.getElementById('startScreen').style.display='none';
  playStartTime=Date.now();
  if(playTimeInterval)clearInterval(playTimeInterval);
  playTimeInterval=setInterval(updatePlayTime,1000);
  drawActiveMonster();
  updateUI();
  setupCameraAndModel();
}

async function setupCameraAndModel(){
  const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  
  try{
    const constraints={
      video:{
        facingMode:"user",
        width:{ideal:isMobile?480:640},
        height:{ideal:isMobile?640:480}
      }
    };
    const stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream;
    await video.play();
  }catch(e){
    showMessage('カメラ起動失敗');
    const canvas=document.getElementById('overlay');
    const ctx=canvas.getContext('2d');
    if(ctx)ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }
  
  function resizeCanvas(){
    canvas.width=window.innerWidth;
    canvas.height=window.innerHeight;
  }
  
  video.onloadedmetadata=()=>{
    resizeCanvas();
  };
  
  window.addEventListener('resize',resizeCanvas);
  window.addEventListener('orientationchange',()=>{
    setTimeout(resizeCanvas,100);
  });
  resizeCanvas();
  
  detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType:poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING});
  isLooping=true;
  loop();
}

function updateUI(){
  const today=new Date().toDateString();
  const savedDate=localStorage.getItem('lastDate');
  if(today!==savedDate){
    dailyTotal=0;
    lastDate=today;
    localStorage.setItem('dailyTotal',0);
    localStorage.setItem('lastDate',today);
  }
  const goal=getStageGoal(currentStage);
  const remaining=Math.max(0,goal-score);
  const hpPercent=(remaining/goal)*100;
  const nameIdx=(currentStage-1)%enemyNames.length;
  const colorIdx=(currentStage-1)%targetColors.length;
  
  document.getElementById('targetHpFill').style.width=hpPercent+'%';
  document.getElementById('targetHpFill').style.background=`linear-gradient(to right,${targetColors[colorIdx]},${targetColors[(colorIdx+1)%targetColors.length]})`;
  document.getElementById('stageInfo').textContent=`ステージ ${currentStage}`;
  document.getElementById('targetHpText').textContent=`HP ${remaining}/${goal}`;
  const enemyImg=document.getElementById('enemyImage');
  const enemyNameEl=document.getElementById('targetName');
  if(nameIdx===0&&enemyMonsterImage.complete){
    enemyImg.src=enemyMonsterImage.src;
    enemyImg.style.display='block';
    enemyImg.style.width='80px';
    enemyImg.style.height='80px';
    enemyImg.style.objectFit='contain';
    enemyImg.style.margin='0 auto 5px';
    enemyNameEl.textContent=enemyNames[nameIdx];
    enemyNameEl.style.fontSize='0.9rem';
  }else{
    enemyImg.style.display='none';
    enemyNameEl.textContent=enemyNames[nameIdx];
    enemyNameEl.style.fontSize='1.2rem';
  }
  const currentCountEl=document.getElementById('currentCount');
  const todayCountEl=document.getElementById('todayCount');
  const totalCountEl=document.getElementById('totalCount');
  const todayCountDisplay=document.getElementById('todayCountDisplay');
  const totalCountDisplay=document.getElementById('totalCountDisplay');
  if(currentCountEl)currentCountEl.textContent=totalSquats;
  if(todayCountEl)todayCountEl.textContent=dailyTotal;
  const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';
  if(todayCountDisplay)todayCountDisplay.style.display=isLoggedIn?'block':'none';
  if(isLoggedIn&&totalCountEl&&totalCountDisplay){
    const savedTotalCount=parseInt(localStorage.getItem('totalCount')||'0');
    totalCountEl.textContent=savedTotalCount;
    totalCountDisplay.style.display='block';
  }else if(totalCountDisplay){
    totalCountDisplay.style.display='none';
  }
  updateTreasureProgress();
}

function applyDamageEffect(d){
  const effectEl=document.getElementById('effect');
  effectEl.textContent='-'+d;
  effectEl.style.color='';
  effectEl.style.fontFamily='';
  effectEl.style.fontSize='';
  effectEl.style.textShadow='';
  effectEl.style.opacity=1;
  setTimeout(()=>{effectEl.style.opacity=0},800);
  
  const gc=document.getElementById('gameContainer');
  gc.classList.remove('shake-1','shake-2','shake-3');
  gc.classList.add(d===1?'shake-1':d===2?'shake-2':'shake-3');
  setTimeout(()=>gc.classList.remove('shake-1','shake-2','shake-3'),200);
}

function handleStageClear(){
  isTransitioning=true;
  document.getElementById('flashEffect').style.opacity=1;
  setTimeout(()=>document.getElementById('flashEffect').style.opacity=0,100);
  
  const effectEl=document.getElementById('effect');
  effectEl.textContent='敵を倒した！';
  effectEl.style.opacity=1;
  
  const ec=document.getElementById('enemyContainer');
  ec.style.opacity=0;
  ec.style.transform='translateX(-50%) scale(0.1) rotate(360deg)';
  
  setTimeout(()=>{
    effectEl.style.opacity=0;
    checkTreasureDrop();
  },1500);
  
  setTimeout(()=>{
    currentStage++;
    score=0;
    currentEnemyIndex=(currentStage-1)%enemyNames.length;
    ec.style.opacity=1;
    ec.style.transform='translateX(-50%) scale(1) rotate(0deg)';
    updateUI();
    isTransitioning=false;
  },2000);
}

let isLooping=false;
let lastPoseTime=0;
const POSE_INTERVAL=16;
async function loop(){
  if(!detector||!isLooping){
    requestAnimationFrame(loop);
    return;
  }
  
  if(!video||video.videoWidth===0||video.videoHeight===0){
    requestAnimationFrame(loop);
    return;
  }
  
  const now=Date.now();
  const shouldDetect=now-lastPoseTime>=POSE_INTERVAL;
  
  const poses=shouldDetect?await detector.estimatePoses(video):null;
  if(shouldDetect)lastPoseTime=now;
  
  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  if(bgEffectEnabled&&bgEffectImage){
    ctx.save();
    ctx.globalAlpha=bgEffectOpacity;
    ctx.drawImage(bgEffectImage,0,0,canvas.width,canvas.height);
    ctx.restore();
  }
  
  const isMobile=window.innerWidth<=768;
  const lineY1=canvas.height*(isMobile?0.65:0.6);
  const lineY2=canvas.height*(isMobile?0.75:0.7);
  const lineY3=canvas.height*(isMobile?0.85:0.8);
  
  let currentNose=null;
  if(poses&&poses.length>0){
    const nose=poses[0].keypoints.find(p=>p.name==='nose');
    if(nose&&nose.score>0.3){
      faceDetected=true;
      currentNose=nose;
      window.lastNose=nose;
    }
  }else if(window.lastNose){
    currentNose=window.lastNose;
  }
  
  if(currentNose&&faceMaskEnabled&&faceMaskImage){
    const noseX=canvas.width-(currentNose.x/video.videoWidth)*canvas.width;
    const noseY=(currentNose.y/video.videoHeight)*canvas.height;
    const radius=faceMaskSize/2;
    ctx.save();
    ctx.beginPath();
    ctx.arc(noseX,noseY,radius,0,Math.PI*2);
    ctx.clip();
    ctx.drawImage(faceMaskImage,noseX-radius,noseY-radius,faceMaskSize,faceMaskSize);
    ctx.restore();
  }
  
  if(faceDetected){
    ctx.lineWidth=4;
    ctx.setLineDash([15,10]);
    ctx.strokeStyle='rgba(255,255,255,0.8)';
    ctx.beginPath();
    ctx.moveTo(0,lineY1);
    ctx.lineTo(canvas.width,lineY1);
    ctx.stroke();
    
    ctx.setLineDash([]);
    ctx.strokeStyle='rgba(255,255,0,0.8)';
    ctx.beginPath();
    ctx.moveTo(0,lineY2);
    ctx.lineTo(canvas.width,lineY2);
    ctx.stroke();
    
    ctx.strokeStyle='rgba(255,0,0,0.8)';
    ctx.beginPath();
    ctx.moveTo(0,lineY3);
    ctx.lineTo(canvas.width,lineY3);
    ctx.stroke();
  }
  
  if(currentNose&&currentNose.score>0.3){
    const videoRect=video.getBoundingClientRect();
    const noseY=(currentNose.y/video.videoHeight)*canvas.height;
    
    if(poses&&poses.length>0){
      
      noseHistory.push(noseY);
      if(noseHistory.length>6)noseHistory.shift();
      const avgY=noseHistory.reduce((a,b)=>a+b,0)/noseHistory.length;
      
      if(avgY>lineY1&&headState==='above'){
        headState='below';
        belowSince=Date.now();
        maxDepthY=avgY;
      }
      
      if(headState==='below'){
        maxDepthY=Math.max(maxDepthY,avgY);
      }
      
      if(avgY<lineY1&&headState==='below'){
        if(Date.now()-belowSince>=250&&!isTransitioning&&isCameraOn){
          let baseDmg=0;
          if(maxDepthY>=lineY3)baseDmg=3;
          else if(maxDepthY>=lineY2)baseDmg=2;
          else if(maxDepthY>=lineY1)baseDmg=1;
          
          if(baseDmg>0){
            const dmg=baseDmg+playerLevel-1;
            const goal=getStageGoal(currentStage);
            const remaining=goal-score;
            const actualDmg=Math.min(dmg,remaining);
            
            score+=actualDmg;
            totalSquats++;
            dailyTotal++;
            localStorage.setItem('dailyTotal',dailyTotal);
            applyDamageEffect(actualDmg);
            updateUI();
            updateMissionProgress();
            
            const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';
            if(isLoggedIn){
              saveUserProgress();
            }
            
            if(score>=goal){
              setTimeout(()=>{
                handleStageClear();
                addExp(currentStage*5);
              },800);
            }
          }
        }
        headState='above';
        noseHistory=[];
        maxDepthY=0;
      }
    }
  }
  
  requestAnimationFrame(loop);
}

function restartGame(sameStage){
  isTransitioning=false;
  if(!sameStage){
    currentStage=1;
  }
  score=0;
  totalSquats=0;
  const ec=document.getElementById('enemyContainer');
  ec.style.opacity=1;
  ec.style.transform='translateX(-50%)';
  updateUI();
  updateExpUI();
}

function showGameOver(){
  document.getElementById('finalStage').textContent=currentStage;
  document.getElementById('finalSquats').textContent=totalSquats;
  document.getElementById('gameOverModal').style.display='flex';
}

function closeModal(){
  document.getElementById('gameOverModal').style.display='none';
}

function shareToX(){
  const stage=currentStage;
  const squats=totalSquats;
  const pattern=document.getElementById('sharePattern').value;
  let text='';
  if(pattern==='1'){
    text='\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3084\u3063\u305f\u3089\n\u30b9\u30c6\u30fc\u30b8'+stage+'\u307e\u3067\u884c\u3051\u305f\ud83d\udd25\n\u660e\u65e5\u306e\u81ea\u5206\u304c\u697d\u3057\u307f\n#AI\u7b4b\u30c8\u30ecRPG';
  }else if(pattern==='2'){
    text='\u30b9\u30c6\u30fc\u30b8'+stage+'\u3067\u8db3\u304c\u9650\u754c\ud83d\ude02\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de...\u307e\u3060\u3044\u3051\u308b\uff01\n#AI\u7b4b\u30c8\u30ecRPG';
  }else{
    text='\u3010\u901f\u5831\u3011\u30b9\u30c6\u30fc\u30b8'+stage+'\u30af\u30ea\u30a2\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3067\u6483\u7834\ud83c\udfae\n\u3053\u306e\u30b2\u30fc\u30e0\u3001\u7b4b\u8089\u75db\u4e0d\u53ef\u907f\n#AI\u7b4b\u30c8\u30ecRPG';
  }
  const shareUrl='https://twitter.com/intent/tweet?text='+encodeURIComponent(text);
  window.open(shareUrl,'_blank','width=550,height=420');
}

function generateResultImage(){
  const canvas=document.createElement('canvas');
  canvas.width=800;
  canvas.height=600;
  const ctx=canvas.getContext('2d');
  
  const gradient=ctx.createLinearGradient(0,0,800,600);
  gradient.addColorStop(0,'#1e3a8a');
  gradient.addColorStop(0.5,'#0891b2');
  gradient.addColorStop(1,'#22d3ee');
  ctx.fillStyle=gradient;
  ctx.fillRect(0,0,800,600);
  
  ctx.fillStyle='#fff';
  ctx.font='bold 60px Arial';
  ctx.textAlign='center';
  ctx.fillText('AI筋トレRPG',400,80);
  
  ctx.fillStyle='rgba(255,255,255,0.95)';
  ctx.fillRect(100,120,600,400);
  
  ctx.fillStyle='#0891b2';
  ctx.font='bold 40px Arial';
  ctx.fillText('ゲーム結果',400,180);
  
  ctx.fillStyle='#333';
  ctx.font='bold 50px Arial';
  ctx.fillText('ステージ '+currentStage,400,260);
  
  ctx.font='bold 45px Arial';
  ctx.fillText('スクワット '+totalSquats+'回',400,330);
  
  ctx.font='bold 40px Arial';
  ctx.fillText('Lv.'+playerLevel,400,400);
  
  ctx.fillStyle='#0891b2';
  ctx.font='30px Arial';
  ctx.fillText('#AI筋トレRPG',400,480);
  
  return canvas;
}

async function shareToXWithImage(){
  const stage=currentStage;
  const squats=totalSquats;
  const pattern=document.getElementById('sharePattern').value;
  let text='';
  if(pattern==='1'){
    text='\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3084\u3063\u305f\u3089\n\u30b9\u30c6\u30fc\u30b8'+stage+'\u307e\u3067\u884c\u3051\u305f\ud83d\udd25\n\u660e\u65e5\u306e\u81ea\u5206\u304c\u697d\u3057\u307f\n#AI\u7b4b\u30c8\u30ecRPG';
  }else if(pattern==='2'){
    text='\u30b9\u30c6\u30fc\u30b8'+stage+'\u3067\u8db3\u304c\u9650\u754c\ud83d\ude02\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de...\u307e\u3060\u3044\u3051\u308b\uff01\n#AI\u7b4b\u30c8\u30ecRPG';
  }else{
    text='\u3010\u901f\u5831\u3011\u30b9\u30c6\u30fc\u30b8'+stage+'\u30af\u30ea\u30a2\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3067\u6483\u7834\ud83c\udfae\n\u3053\u306e\u30b2\u30fc\u30e0\u3001\u7b4b\u8089\u75db\u4e0d\u53ef\u907f\n#AI\u7b4b\u30c8\u30ecRPG';
  }
  
  if(navigator.share&&navigator.canShare){
    try{
      const canvas=generateResultImage();
      const blob=await new Promise(resolve=>canvas.toBlob(resolve,'image/png'));
      const file=new File([blob],'result.png',{type:'image/png'});
      
      if(navigator.canShare({files:[file]})){
        await navigator.share({text:text,files:[file]});
        const username=localStorage.getItem('username')||'guest';
        let count=parseInt(localStorage.getItem('goldTreasureCount_'+username)||'0');
        count++;
        localStorage.setItem('goldTreasureCount_'+username,count);
        showMessage('\u30b4\u30fc\u30eb\u30c9\u5b9d\u7bb1\u3092\u7372\u5f97\uff01');
        return;
      }
    }catch(e){
      console.log('Share failed:',e);
    }
  }
  
  shareToX();
}

let isSaving=false;
function saveScoreToSheet(){
  if(isSaving)return;
  const name=document.getElementById('playerName').value.trim();
  if(!name){
    showMessage('プレイヤー名を入力してください');
    return;
  }
  isSaving=true;
  showLoading('スコア保存中...');
  google.script.run
    .withSuccessHandler(r=>{
      hideLoading();
      showMessage(r.message);
      setTimeout(()=>backToTitle(),1500);
      isSaving=false;
    })
    .withFailureHandler(e=>{hideLoading();showMessage('保存失敗: '+e);isSaving=false;})
    .saveScore(name,currentStage,totalSquats);
}

function showMessage(msg){
  const effectEl=document.getElementById('effect');
  effectEl.textContent=msg;
  effectEl.style.color='#fff';
  effectEl.style.fontFamily='"Arial Black",Impact,sans-serif';
  effectEl.style.fontSize='clamp(1.5rem,6vw,2.5rem)';
  effectEl.style.textShadow='3px 3px 0 #000,-3px -3px 0 #000,3px -3px 0 #000,-3px 3px 0 #000,0 0 20px rgba(255,255,255,0.8)';
  effectEl.style.opacity=1;
  setTimeout(()=>effectEl.style.opacity=0,2000);
}

function showConfirm(msg,onConfirm){
  const modal=document.createElement('div');
  modal.style.position='fixed';
  modal.style.inset='0';
  modal.style.background='rgba(0,0,0,0.8)';
  modal.style.zIndex='10000';
  modal.style.display='flex';
  modal.style.alignItems='center';
  modal.style.justifyContent='center';
  const box=document.createElement('div');
  box.style.background='linear-gradient(135deg,#1e3a8a,#06b6d4)';
  box.style.padding='30px';
  box.style.borderRadius='20px';
  box.style.textAlign='center';
  box.style.maxWidth='90%';
  box.innerHTML='<p style="color:#fff;font-size:1.2rem;margin:0 0 20px 0;white-space:pre-wrap">'+msg+'</p>';
  const btnYes=document.createElement('button');
  btnYes.textContent='OK';
  btnYes.style.padding='12px 30px';
  btnYes.style.fontSize='1.1rem';
  btnYes.style.background='#4CAF50';
  btnYes.style.color='#fff';
  btnYes.style.border='none';
  btnYes.style.borderRadius='8px';
  btnYes.style.cursor='pointer';
  btnYes.style.margin='5px';
  btnYes.onclick=function(){
    document.body.removeChild(modal);
    onConfirm();
  };
  const btnNo=document.createElement('button');
  btnNo.textContent='キャンセル';
  btnNo.style.padding='12px 30px';
  btnNo.style.fontSize='1.1rem';
  btnNo.style.background='#999';
  btnNo.style.color='#fff';
  btnNo.style.border='none';
  btnNo.style.borderRadius='8px';
  btnNo.style.cursor='pointer';
  btnNo.style.margin='5px';
  btnNo.onclick=function(){
    document.body.removeChild(modal);
  };
  box.appendChild(btnYes);
  box.appendChild(btnNo);
  modal.appendChild(box);
  document.body.appendChild(modal);
}

function showStartScreen(){
const startScreen=document.getElementById('startScreen');
const loginButton=document.getElementById('loginButton');
const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';
if(loginButton){
loginButton.style.display=isLoggedIn?'none':'block';
}
startScreen.style.display='flex';
}

function backToTitle(){
  const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';
  if(isLoggedIn){
    saveUserProgress();
  }
  totalSquats=0;
  restartGame(false);
  document.getElementById('gameOverModal').style.display='none';
  if(playTimeInterval)clearInterval(playTimeInterval);
  playStartTime=0;
  document.getElementById('playTime').textContent='00:00';
  
  const logoutBtn=document.getElementById('logoutBtn');
  if(logoutBtn)logoutBtn.style.display=isLoggedIn?'block':'none';
  
  showStartScreen();
}

function logout(){
  const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';
  if(!isLoggedIn){
    showMessage('ゲストモードです');
    return;
  }
  showConfirm('ログアウトしますか？\nデータは保存されます。',function(){
    saveUserProgress();
    saveMissions();
    localStorage.removeItem('isLoggedIn');
    document.getElementById('startScreen').style.display='none';
    document.getElementById('gameContainer').style.display='none';
    if(playTimeInterval)clearInterval(playTimeInterval);
    playStartTime=0;
    document.getElementById('playTime').textContent='00:00';
    if(isLooping){
      isLooping=false;
      const stream=video.srcObject;
      if(stream){
        stream.getTracks().forEach(track=>track.stop());
        video.srcObject=null;
      }
    }
    showLoginScreen();
  });
}
function loadRankingData(){
const tbody=document.getElementById('rankingTable');
if(!tbody)return;
const SHEET_ID='180zH4Ba5OTXMCN5abNQQsICWACn6IKTNQ0q8Wo8jmuc';
const SHEET_NAME='スコア';
const url='https://docs.google.com/spreadsheets/d/'+SHEET_ID+'/gviz/tq?tqx=out:json&sheet='+SHEET_NAME;
fetch(url).then(function(r){return r.text();}).then(function(text){
const json=JSON.parse(text.substr(47).slice(0,-2));
const rows=json.table.rows;
if(rows.length<=1){tbody.innerHTML='<tr><td colspan="4" style="padding:20px;text-align:center">データがありません</td></tr>';return;}
const scores=rows.slice(1).map(function(r){return{name:r.c[1]?r.c[1].v:'',stage:r.c[3]?r.c[3].v:0,squats:r.c[4]?r.c[4].v:0};}).filter(function(s){return s.name;});
scores.sort(function(a,b){return b.stage-a.stage||b.squats-a.squats;});
let html='';
scores.slice(0,10).forEach(function(item,i){
const rank=i+1;
let color='#333';
if(rank===1)color='#FFD700';
else if(rank===2)color='#C0C0C0';
else if(rank===3)color='#CD7F32';
html+='<tr style="border-bottom:1px solid #eee"><td style="padding:10px;text-align:center;font-weight:bold;color:'+color+'">'+rank+'</td><td style="padding:10px;text-align:center">'+item.name+'</td><td style="padding:10px;text-align:center"><strong>'+item.stage+'</strong></td><td style="padding:10px;text-align:center">'+item.squats+'</td></tr>';
});
tbody.innerHTML=html;
}).catch(function(){tbody.innerHTML='<tr><td colspan="4" style="padding:20px;text-align:center">読み込みエラー</td></tr>';});
}
function showStarterSelection(){
  const modal=document.createElement('div');
  modal.id='starterModal';
  modal.style.position='fixed';
  modal.style.inset='0';
  modal.style.background='rgba(0,0,0,0.9)';
  modal.style.zIndex='10001';
  modal.style.display='flex';
  modal.style.alignItems='center';
  modal.style.justifyContent='center';
  modal.style.padding='10px';
  const box=document.createElement('div');
  box.style.background='linear-gradient(135deg,#1e3a8a,#06b6d4)';
  box.style.padding='20px';
  box.style.borderRadius='20px';
  box.style.textAlign='center';
  box.style.maxWidth='500px';
  box.style.width='100%';
  const title=document.createElement('h2');
  title.textContent='最初のモンスターを選んでください';
  title.style.color='#fff';
  title.style.marginBottom='20px';
  title.style.fontSize='clamp(1.2rem,5vw,1.8rem)';
  title.style.whiteSpace='nowrap';
  box.appendChild(title);
  const grid=document.createElement('div');
  grid.style.display='grid';
  grid.style.gridTemplateColumns='repeat(3,1fr)';
  grid.style.gap='10px';
  grid.style.marginBottom='20px';
  const starters=['slime','tonton','tororarero'];
  starters.forEach(id=>{
    const monster=monsterTypes.find(m=>m.id===id);
    const div=document.createElement('div');
    div.style.background='#fff';
    div.style.borderRadius='15px';
    div.style.padding='10px';
    div.style.cursor='pointer';
    div.style.border='3px solid '+(monster.rarity==='rare'?'#FFD700':'#999');
    div.style.transition='transform 0.2s';
    div.onmouseover=()=>div.style.transform='scale(1.05)';
    div.onmouseout=()=>div.style.transform='scale(1)';
    div.onclick=()=>{
      localStorage.setItem('activeMonster',id);
      localStorage.setItem('ownedMonsters',JSON.stringify([{id:id,level:1,exp:0}]));
      document.body.removeChild(modal);
      updateUI();
      updateExpUI();
      drawActiveMonster();
      drawTreasureBoxIcon();
    };
    const canvas=document.createElement('canvas');
    canvas.width=80;
    canvas.height=80;
    const ctx=canvas.getContext('2d');
    drawMonster(ctx,id,40,40,30);
    div.appendChild(canvas);
    const name=document.createElement('div');
    name.textContent=monster.name;
    name.style.color='#000';
    name.style.fontWeight='bold';
    name.style.fontSize='0.7rem';
    name.style.marginTop='8px';
    div.appendChild(name);
    grid.appendChild(div);
  });
  box.appendChild(grid);
  modal.appendChild(box);
  document.body.appendChild(modal);
}

window.addEventListener('DOMContentLoaded',function(){
  video=document.getElementById('video');
  canvas=document.getElementById('overlay');
  ctx=canvas.getContext('2d');
  
  initBGMAudio();
  
  const loginStatus=localStorage.getItem('isLoggedIn');
  if(loginStatus===null||loginStatus===undefined||loginStatus==='false'){
    showLoginScreen();
    return;
  }
  const isLoggedIn=loginStatus==='true';
  
  const username=localStorage.getItem('username')||'ゲスト';
  const userDisplay=document.getElementById('userDisplay');
  if(userDisplay&&isLoggedIn)userDisplay.textContent=username;
  
  const savedDaily=localStorage.getItem('dailyTotal');
  const savedDate=localStorage.getItem('lastDate');
  const today=new Date().toDateString();
  if(savedDate===today&&savedDaily){
    dailyTotal=parseInt(savedDaily);
  }else{
    dailyTotal=0;
    localStorage.setItem('dailyTotal',0);
    localStorage.setItem('lastDate',today);
  }
  lastDate=today;
  
  currentEnemyIndex=0;
  
  if(isLoggedIn){
    const savedLevel=localStorage.getItem('playerLevel');
    const savedExp=localStorage.getItem('playerExp');
    if(savedLevel)playerLevel=parseInt(savedLevel);
    if(savedExp)playerExp=parseInt(savedExp);
  }else{
    playerLevel=1;
    playerExp=0;
  }
  updateExpUI();
  
  const logoutBtn=document.getElementById('logoutBtn');
  if(logoutBtn)logoutBtn.style.display=isLoggedIn?'block':'none';
  const missionBtn=document.getElementById('missionBtn');
  if(missionBtn)missionBtn.style.display=isLoggedIn?'block':'none';
  
  showStartScreen();
  
  if(!localStorage.getItem('activeMonster')){
    showStarterSelection();
  }else{
    updateUI();
    updateExpUI();
    drawActiveMonster();
    drawTreasureBoxIcon();
  }
});

function drawTreasureBox(ctx,x,y,size){
  ctx.fillStyle='#8B4513';
  ctx.fillRect(x-size/2,y-size/2,size,size*0.8);
  ctx.fillStyle='#FFD700';
  ctx.fillRect(x-size/2,y-size/2,size,size*0.2);
  ctx.fillRect(x-size*0.1,y-size/2,size*0.2,size*0.8);
  ctx.fillStyle='#FF0000';
  ctx.beginPath();
  ctx.arc(x,y-size/2,size*0.15,0,Math.PI*2);
  ctx.fill();
}

function drawTreasureBoxIcon(){
  const canvas=document.getElementById('treasureBoxCanvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  drawTreasureBox(ctx,40,40,40);
}

function drawItemIcon(ctx,type,x,y,size){
  if(type==='rare'){
    if(rareGachaImg.complete){
      ctx.drawImage(rareGachaImg,x-size,y-size,size*2,size*2);
    }else{
      ctx.fillStyle='#FFD700';
      ctx.beginPath();
      ctx.arc(x,y,size,0,Math.PI*2);
      ctx.fill();
    }
  }else if(type==='normal'){
    if(normalGachaImg.complete){
      ctx.drawImage(normalGachaImg,x-size,y-size,size*2,size*2);
    }else{
      ctx.fillStyle='#4CAF50';
      ctx.beginPath();
      ctx.arc(x,y,size,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle='#000';
      ctx.beginPath();
      ctx.arc(x-size*0.3,y-size*0.2,size*0.15,0,Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x+size*0.3,y-size*0.2,size*0.15,0,Math.PI*2);
      ctx.fill();
    }
  }else{
    ctx.fillStyle='#666';
    ctx.beginPath();
    ctx.arc(x,y,size,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='#fff';
    ctx.lineWidth=size*0.2;
    ctx.beginPath();
    ctx.moveTo(x-size*0.5,y-size*0.5);
    ctx.lineTo(x+size*0.5,y+size*0.5);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x+size*0.5,y-size*0.5);
    ctx.lineTo(x-size*0.5,y+size*0.5);
    ctx.stroke();
  }
}

function drawMonster(ctx,monsterId,x,y,size){
  ctx.save();
  ctx.imageSmoothingEnabled=true;
  ctx.imageSmoothingQuality='high';
  ctx.translate(x,y);
  if(monsterId==='slime'&&imageCache['slime']&&imageCache['slime'].complete){
    const imgSize=size*3;
    ctx.drawImage(imageCache['slime'],-imgSize/2,-imgSize/2,imgSize,imgSize);
  }else if(monsterId==='tonton'&&imageCache['tonton']&&imageCache['tonton'].complete){
    const imgSize=size*3;
    ctx.drawImage(imageCache['tonton'],-imgSize/2,-imgSize/2,imgSize,imgSize);
  }else if(monsterId==='dragon'){
    ctx.fillStyle='#FF4500';
    ctx.beginPath();
    ctx.ellipse(0,0,size*1.2,size,0,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle='#FFD700';
    ctx.beginPath();
    ctx.arc(-size*0.4,-size*0.3,size*0.2,0,Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(size*0.4,-size*0.3,size*0.2,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='#8B0000';
    ctx.lineWidth=3;
    ctx.beginPath();
    ctx.moveTo(-size*0.6,size*0.3);
    ctx.lineTo(-size*0.8,size*0.8);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(size*0.6,size*0.3);
    ctx.lineTo(size*0.8,size*0.8);
    ctx.stroke();
  }else if(monsterId==='udindindin'&&imageCache['udindindin']&&imageCache['udindindin'].complete){
    const imgSize=size*3;
    ctx.drawImage(imageCache['udindindin'],-imgSize/2,-imgSize/2,imgSize,imgSize);
  }else if(monsterId==='panking'&&imageCache['panking']&&imageCache['panking'].complete){
    const imgSize=size*3;
    ctx.drawImage(imageCache['panking'],-imgSize/2,-imgSize/2,imgSize,imgSize);
  }else if(monsterId==='cappuccino'&&imageCache['cappuccino']&&imageCache['cappuccino'].complete){
    const imgSize=size*3;
    ctx.drawImage(imageCache['cappuccino'],-imgSize/2,-imgSize/2,imgSize,imgSize);
  }else if(monsterId==='tororarero'&&imageCache['tororarero']&&imageCache['tororarero'].complete){
    const imgSize=size*3;
    ctx.drawImage(imageCache['tororarero'],-imgSize/2,-imgSize/2,imgSize,imgSize);
  }else if(monsterId==='caneloni'&&imageCache['caneloni']&&imageCache['caneloni'].complete){
    const imgSize=size*3;
    ctx.drawImage(imageCache['caneloni'],-imgSize/2,-imgSize/2,imgSize,imgSize);
  }
  ctx.restore();
}

let activeMonsterCanvas=null;
function drawActiveMonster(){
  const container=document.getElementById('myCharacter');
  if(!container)return;
  if(activeMonsterCanvas){
    container.removeChild(activeMonsterCanvas);
  }
  const canvas=document.createElement('canvas');
  canvas.width=120;
  canvas.height=120;
  activeMonsterCanvas=canvas;
  container.appendChild(canvas);
  const ctx=canvas.getContext('2d');
  const activeMonster=localStorage.getItem('activeMonster')||'slime';
  
  const monsterNameEl=document.getElementById('myMonsterName');
  if(monsterNameEl){
    const monsterInfo=monsterTypes.find(m=>m.id===activeMonster);
    monsterNameEl.textContent=monsterInfo?monsterInfo.name:'スライム';
    monsterNameEl.style.color='#000';
    monsterNameEl.style.fontWeight='900';
    monsterNameEl.style.filter='drop-shadow(0 0 3px #fff) drop-shadow(0 0 6px #fff)';
  }
  
  function animate(){
    const time=Date.now()*0.002;
    const bounce=Math.sin(time*2)*5;
    ctx.clearRect(0,0,120,120);
    ctx.save();
    ctx.translate(60,60+bounce);
    drawMonster(ctx,activeMonster,0,0,35);
    ctx.restore();
    requestAnimationFrame(animate);
  }
  animate();
}

function updateTreasureProgress(){}

function checkTreasureDrop(){
  const dropRate=Math.min(10+currentStage*2,90);
  const rand=Math.random()*100;
  if(rand<dropRate){
    let type='bronze';
    let rates={bronze:80,silver:0,gold:0};
    if(currentStage>=10)rates.silver=15;
    if(currentStage>=30)rates.gold=5;
    const typeRand=Math.random()*100;
    if(currentStage>=30&&typeRand<rates.gold)type='gold';
    else if(currentStage>=10&&typeRand<rates.gold+rates.silver)type='silver';
    
    const dropText=document.getElementById('treasureDropText');
    if(dropText){
      const colors={bronze:'#CD7F32',silver:'#C0C0C0',gold:'#FFD700'};
      const names={bronze:'ブロンズ宝箱',silver:'シルバー宝箱',gold:'ゴールド宝箱'};
      dropText.textContent=names[type]+'ドロップ！';
      dropText.style.color=colors[type];
      dropText.style.textShadow='0 0 10px '+colors[type]+',0 0 20px '+colors[type]+',3px 3px 0 #000,-3px -3px 0 #000';
      dropText.style.opacity=1;
      setTimeout(()=>dropText.style.opacity=0,2000);
    }
    const username=localStorage.getItem('username')||'guest';
    let count=parseInt(localStorage.getItem(type+'TreasureCount_'+username)||'0');
    count++;
    localStorage.setItem(type+'TreasureCount_'+username,count);
  }
}

function openItems(){
  const username=localStorage.getItem('username')||'guest';
  document.getElementById('bronzeTreasureCount').textContent=localStorage.getItem('bronzeTreasureCount_'+username)||'0';
  document.getElementById('silverTreasureCount').textContent=localStorage.getItem('silverTreasureCount_'+username)||'0';
  document.getElementById('goldTreasureCount').textContent=localStorage.getItem('goldTreasureCount_'+username)||'0';
  document.getElementById('itemModal').style.display='flex';
  document.getElementById('gachaModal').style.display='none';
}

function closeItemModal(){
  document.getElementById('itemModal').style.display='none';
  setTimeout(function(){
    if(!isLooping&&detector&&isCameraOn){
      isLooping=true;
      loop();
    }
  },100);
}

const monsterTypes=[
  {id:'slime',name:'スライム',color:'#4CAF50',rarity:'normal',image:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/slime.png'},
  {id:'tonton',name:'トゥントゥントゥンサフール',color:'#8B4513',rarity:'normal',image:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/tonton.png'},
  {id:'panking',name:'パンプキング',color:'#FF8C00',rarity:'rare',image:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/panking.png'},
  {id:'cappuccino',name:'カプチーノアサシーノ',color:'#8B4513',rarity:'normal',image:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/cappuccino-assassino.png'},
  {id:'tororarero',name:'トララレロ',color:'#00CED1',rarity:'normal',image:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/tororarero.png'},
  {id:'caneloni',name:'カネロニ・ドラゴーニ',color:'#FFA500',rarity:'rare',image:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/caneloni-dragoni.png'},
  {id:'udindindin',name:'ウ・ディンディンディンドゥンマディンディンディンドゥン',color:'#9370DB',rarity:'rare',image:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/udindindindindunmadindindindun.png'}
];
const imageCache={};
monsterTypes.forEach(m=>{
  if(m.image){
    const img=new Image();
    img.src=m.image;
    imageCache[m.id]=img;
  }
});
const normalGachaImg=new Image();
normalGachaImg.src='https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/rare-gacha.png';
const rareGachaImg=new Image();
rareGachaImg.src='https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/super-rare-gacha.png';
const treasureRates={
  bronze:[{icon:'rare',name:'レアモンスター',rate:0.005,color:'#FFD700'},{icon:'normal',name:'モンスター',rate:0.095,color:'#4CAF50'},{icon:'miss',name:'はずれ',rate:0.9,color:'#999'}],
  silver:[{icon:'rare',name:'レアモンスター',rate:0.03,color:'#FFD700'},{icon:'normal',name:'モンスター',rate:0.17,color:'#4CAF50'},{icon:'miss',name:'はずれ',rate:0.8,color:'#999'}],
  gold:[{icon:'rare',name:'レアモンスター',rate:0.15,color:'#FFD700'},{icon:'normal',name:'モンスター',rate:0.35,color:'#4CAF50'},{icon:'miss',name:'はずれ',rate:0.5,color:'#999'}]
};

function openTreasureBox(type){
  const username=localStorage.getItem('username')||'guest';
  let treasureCount=parseInt(localStorage.getItem(type+'TreasureCount_'+username)||'0');
  if(treasureCount<=0){
    document.getElementById('resultText').textContent='宝箱がありません';
    document.getElementById('gachaModal').style.display='flex';
    document.getElementById('resultIcon').style.display='none';
    document.getElementById('rouletteContainer').style.display='none';
    document.getElementById('gachaButtons').style.display='block';
    return;
  }
  treasureCount--;
  localStorage.setItem(type+'TreasureCount_'+username,treasureCount);
  document.getElementById(type+'TreasureCount').textContent=treasureCount;
  const items=treasureRates[type];
  document.getElementById('gachaModal').style.display='flex';
  document.getElementById('resultIcon').style.display='none';
  document.getElementById('resultIcon').innerHTML='';
  document.getElementById('gachaButtons').style.display='none';
  document.getElementById('resultText').textContent='ルーレット回転中...';
  document.getElementById('rouletteContainer').style.display='block';
  const roulette=document.getElementById('roulette');
  roulette.innerHTML='';
  roulette.style.display='flex';
  roulette.style.transition='none';
  roulette.style.transform='translateX(0px)';
  const itemWidth=100;
  const itemsArray=[];
  for(let i=0;i<30;i++){
    itemsArray.push(items[i%items.length]);
  }
  itemsArray.forEach((item,i)=>{
    const div=document.createElement('div');
    div.style.minWidth=itemWidth+'px';
    div.style.height='100%';
    div.style.display='flex';
    div.style.alignItems='center';
    div.style.justifyContent='center';
    div.style.background=item.color;
    div.style.borderRight='2px solid #fff';
    const canvas=document.createElement('canvas');
    canvas.width=80;
    canvas.height=80;
    const ctx=canvas.getContext('2d');
    drawItemIcon(ctx,item.icon,40,40,30);
    div.appendChild(canvas);
    roulette.appendChild(div);
  });
  const rand=Math.random();
  let result=items[items.length-1];
  let cumulative=0;
  for(let i=0;i<items.length;i++){
    cumulative+=items[i].rate;
    if(rand<cumulative){
      result=items[i];
      break;
    }
  }
  window.currentGachaType=type;
  const resultIndex=items.indexOf(result)+15;
  const containerWidth=roulette.parentElement.offsetWidth;
  const targetX=-(resultIndex*itemWidth)+(containerWidth/2)-(itemWidth/2);
  const spinDuration=3000;
  const startTime=Date.now();
  const startX=containerWidth;
  function spin(){
    const elapsed=Date.now()-startTime;
    const progress=Math.min(elapsed/spinDuration,1);
    const easeOut=1-Math.pow(1-progress,3);
    const currentX=startX+(targetX-startX)*easeOut;
    roulette.style.transform='translateX('+currentX+'px)';
    if(progress<1){
      requestAnimationFrame(spin);
    }else{
      showGachaResult(result);
    }
  }
  spin();
}

function showGachaResult(result){
  setTimeout(function(){
    document.getElementById('rouletteContainer').style.display='none';
    const resultIcon=document.getElementById('resultIcon');
    resultIcon.innerHTML='';
    if(result.name==='はずれ'){
      const canvas=document.createElement('canvas');
      canvas.width=100;
      canvas.height=100;
      const ctx=canvas.getContext('2d');
      drawItemIcon(ctx,result.icon,50,50,40);
      resultIcon.appendChild(canvas);
      document.getElementById('resultText').textContent='はずれ...';
    }else{
      let monster;
      if(result.name==='レアモンスター'){
        const rareMonsters=monsterTypes.filter(m=>m.rarity==='rare');
        monster=rareMonsters[Math.floor(Math.random()*rareMonsters.length)];
      }else{
        const normalMonsters=monsterTypes.filter(m=>m.rarity==='normal');
        monster=normalMonsters[Math.floor(Math.random()*normalMonsters.length)];
      }
      let ownedMonsters=JSON.parse(localStorage.getItem('ownedMonsters')||'[{"id":"slime","level":1,"exp":0}]');
      const isNew=!ownedMonsters.find(m=>m.id===monster.id);
      if(isNew){
        ownedMonsters.push({id:monster.id,level:1,exp:0});
        localStorage.setItem('ownedMonsters',JSON.stringify(ownedMonsters));
      }
      const div=document.createElement('div');
      div.style.background=isNew?'linear-gradient(135deg,#FFD700,#FFA500)':'#f0f0f0';
      div.style.borderRadius='10px';
      div.style.padding='15px';
      div.style.textAlign='center';
      div.style.border=isNew?'3px solid #FF4500':'2px solid #ccc';
      const canvas=document.createElement('canvas');
      canvas.width=80;
      canvas.height=80;
      const ctx=canvas.getContext('2d');
      drawMonster(ctx,monster.id,40,40,30);
      div.appendChild(canvas);
      const name=document.createElement('div');
      name.textContent=monster.name;
      name.style.fontSize='1rem';
      name.style.fontWeight='bold';
      name.style.color='#333';
      name.style.marginTop='8px';
      div.appendChild(name);
      if(isNew){
        const badge=document.createElement('div');
        badge.textContent='NEW!';
        badge.style.fontSize='0.8rem';
        badge.style.color='#FF0000';
        badge.style.fontWeight='bold';
        badge.style.marginTop='5px';
        div.appendChild(badge);
        document.getElementById('resultText').textContent=monster.name+'獲得！';
      }else{
        document.getElementById('resultText').textContent=monster.name+'獲得！\n（持ってます）';
      }
      resultIcon.appendChild(div);
    }
    resultIcon.style.display='block';
    document.getElementById('gachaButtons').style.display='block';
  },500);
}

function openTreasureBoxAll(){
  let treasureCount=parseInt(localStorage.getItem('treasureCount')||'0');
  if(treasureCount<=0){
    document.getElementById('resultText').textContent='宝箱がありません';
    document.getElementById('gachaModal').style.display='flex';
    document.getElementById('resultIcon').style.display='none';
    document.getElementById('roulette').style.display='none';
    document.getElementById('gachaButtons').style.display='block';
    return;
  }
  const pullCount=treasureCount;
  treasureCount=0;
  localStorage.setItem('treasureCount',treasureCount);
  document.getElementById('treasureCountModal').textContent=treasureCount;
  
  let ownedMonsters=JSON.parse(localStorage.getItem('ownedMonsters')||'[{"id":"slime","level":1,"exp":0}]');
  let newMonsters=[];
  let missCount=0;
  
  for(let i=0;i<pullCount;i++){
    const rand=Math.random();
    let result=items[items.length-1];
    let cumulative=0;
    for(let j=0;j<items.length;j++){
      cumulative+=items[j].rate;
      if(rand<cumulative){
        result=items[j];
        break;
      }
    }
    if(result.name==='はずれ'){
      missCount++;
    }else{
      let monster;
      if(result.name==='レアモンスター'){
        const rareMonsters=monsterTypes.filter(m=>m.rarity==='rare');
        monster=rareMonsters[Math.floor(Math.random()*rareMonsters.length)];
      }else{
        const normalMonsters=monsterTypes.filter(m=>m.rarity==='normal');
        monster=normalMonsters[Math.floor(Math.random()*normalMonsters.length)];
      }
      const isNew=!ownedMonsters.find(m=>m.id===monster.id);
      if(isNew){
        ownedMonsters.push({id:monster.id,level:1,exp:0});
        newMonsters.push({monster:monster,isNew:true});
      }else{
        newMonsters.push({monster:monster,isNew:false});
      }
    }
  }
  localStorage.setItem('ownedMonsters',JSON.stringify(ownedMonsters));
  
  document.getElementById('itemModal').style.display='none';
  document.getElementById('gachaModal').style.display='flex';
  document.getElementById('resultIcon').style.display='none';
  document.getElementById('gachaButtons').style.display='none';
  document.getElementById('rouletteContainer').style.display='none';
  
  const resultDiv=document.createElement('div');
  resultDiv.style.maxHeight='300px';
  resultDiv.style.overflowY='auto';
  resultDiv.style.display='grid';
  resultDiv.style.gridTemplateColumns='repeat(auto-fill,minmax(80px,1fr))';
  resultDiv.style.gap='10px';
  resultDiv.style.padding='10px';
  
  newMonsters.forEach(item=>{
    const div=document.createElement('div');
    div.style.background=item.isNew?'linear-gradient(135deg,#FFD700,#FFA500)':'#f0f0f0';
    div.style.borderRadius='10px';
    div.style.padding='10px';
    div.style.textAlign='center';
    div.style.border=item.isNew?'3px solid #FF4500':'2px solid #ccc';
    const canvas=document.createElement('canvas');
    canvas.width=60;
    canvas.height=60;
    const ctx=canvas.getContext('2d');
    drawMonster(ctx,item.monster.id,30,30,25);
    div.appendChild(canvas);
    const name=document.createElement('div');
    name.textContent=item.monster.name;
    name.style.fontSize='0.7rem';
    name.style.fontWeight='bold';
    name.style.color='#333';
    name.style.marginTop='5px';
    div.appendChild(name);
    if(item.isNew){
      const badge=document.createElement('div');
      badge.textContent='NEW!';
      badge.style.fontSize='0.6rem';
      badge.style.color='#FF0000';
      badge.style.fontWeight='bold';
      div.appendChild(badge);
    }
    resultDiv.appendChild(div);
  });
  
  let summaryText=pullCount+'回ガチャ結果<br>';
  summaryText+='モンスター: '+(pullCount-missCount)+'体<br>';
  summaryText+='はずれ: '+missCount+'回<br>';
  const newCount=newMonsters.filter(m=>m.isNew).length;
  if(newCount>0)summaryText+='NEW: '+newCount+'体';
  
  document.getElementById('resultText').innerHTML=summaryText;
  const resultIcon=document.getElementById('resultIcon');
  resultIcon.innerHTML='';
  resultIcon.appendChild(resultDiv);
  resultIcon.style.display='block';
  document.getElementById('gachaButtons').style.display='block';
}

function closeGachaModal(){
  document.getElementById('gachaModal').style.display='none';
  setTimeout(function(){
    if(!isLooping&&detector&&isCameraOn){
      isLooping=true;
      loop();
    }
  },100);
}

function openMonsters(){
  const ownedMonsters=JSON.parse(localStorage.getItem('ownedMonsters')||'[{"id":"slime","level":1,"exp":0}]');
  const activeMonster=localStorage.getItem('activeMonster')||'slime';
  const activeMonsterData=ownedMonsters.find(m=>m.id===activeMonster);
  if(activeMonsterData){
    activeMonsterData.level=playerLevel;
    activeMonsterData.exp=playerExp;
    localStorage.setItem('ownedMonsters',JSON.stringify(ownedMonsters));
  }
  const grid=document.getElementById('monsterGrid');
  grid.innerHTML='';
  monsterTypes.forEach(monster=>{
    const div=document.createElement('div');
    const isOwned=ownedMonsters.some(m=>m.id===monster.id);
    const isActive=monster.id===activeMonster;
    div.style.background='#fff';
    div.style.borderRadius='15px';
    div.style.padding='15px';
    div.style.textAlign='center';
    div.style.border='3px solid '+(isActive?'#00FF00':monster.rarity==='rare'?'#FFD700':'#999');
    div.style.minHeight='100px';
    div.style.display='flex';
    div.style.flexDirection='column';
    div.style.alignItems='center';
    div.style.justifyContent='center';
    div.style.cursor=isOwned?'pointer':'default';
    div.style.transition='transform 0.2s';
    if(isOwned){
      div.onmouseover=()=>div.style.transform='scale(1.05)';
      div.onmouseout=()=>div.style.transform='scale(1)';
      div.onclick=()=>{
        if(isActive){
          showMessage('すでに使用中です');
          return;
        }
        const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';
        const confirmMsg=isLoggedIn?monster.name+'に入れ替えますか？\nレベルは引き継がれます。':monster.name+'に入れ替えますか？\nレベルはリセットされます。';
        showConfirm(confirmMsg,function(){
          const ownedMonsters=JSON.parse(localStorage.getItem('ownedMonsters')||'[{"id":"slime","level":1,"exp":0}]');
          const currentActiveMonster=ownedMonsters.find(m=>m.id===activeMonster);
          if(currentActiveMonster&&isLoggedIn){
            currentActiveMonster.level=playerLevel;
            currentActiveMonster.exp=playerExp;
          }
          
          localStorage.setItem('activeMonster',monster.id);
          
          const newActiveMonster=ownedMonsters.find(m=>m.id===monster.id);
          if(isLoggedIn){
            if(newActiveMonster){
              playerLevel=newActiveMonster.level||1;
              playerExp=newActiveMonster.exp||0;
            }else{
              ownedMonsters.push({id:monster.id,level:1,exp:0});
              playerLevel=1;
              playerExp=0;
            }
            localStorage.setItem('ownedMonsters',JSON.stringify(ownedMonsters));
          }else{
            playerLevel=1;
            playerExp=0;
          }
          
          localStorage.setItem('playerLevel',playerLevel);
          localStorage.setItem('playerExp',playerExp);
          updateExpUI();
          drawActiveMonster();
          closeMonsterModal();
          saveUserProgress();
        });
      };
      const canvas=document.createElement('canvas');
      canvas.width=60;
      canvas.height=60;
      const ctx=canvas.getContext('2d');
      drawMonster(ctx,monster.id,30,30,25);
      div.appendChild(canvas);
      const name=document.createElement('div');
      name.textContent=monster.name;
      name.style.color='#000';
      name.style.fontWeight='900';
      const nameLen=monster.name.length;
      if(nameLen<=5)name.style.fontSize='0.8rem';
      else if(nameLen<=7)name.style.fontSize='0.7rem';
      else if(nameLen<=10)name.style.fontSize='0.6rem';
      else name.style.fontSize='0.5rem';
      name.style.padding='4px 3px';
      name.style.borderRadius='8px';
      name.style.marginTop='6px';
      name.style.whiteSpace='nowrap';
      name.style.lineHeight='1.1';
      name.style.maxWidth='100%';
      name.style.overflow='hidden';
      name.style.textOverflow='ellipsis';
      name.style.filter='drop-shadow(0 0 3px #fff) drop-shadow(0 0 6px #fff)';
      div.appendChild(name);
      
      const monsterData=ownedMonsters.find(m=>m.id===monster.id);
      if(monsterData){
        const levelText=document.createElement('div');
        levelText.textContent='Lv.'+(isActive?playerLevel:monsterData.level||1);
        levelText.style.color='#000';
        levelText.style.fontSize='0.8rem';
        levelText.style.fontWeight='bold';
        levelText.style.marginTop='3px';
        div.appendChild(levelText);
      }
      
      if(monster.id==='panking'){
        const collabBadge=document.createElement('div');
        collabBadge.textContent='コラボ';
        collabBadge.style.background='linear-gradient(135deg,#FF6B6B,#FF8E53)';
        collabBadge.style.color='#fff';
        collabBadge.style.fontSize='0.6rem';
        collabBadge.style.fontWeight='bold';
        collabBadge.style.padding='2px 6px';
        collabBadge.style.borderRadius='4px';
        collabBadge.style.marginTop='3px';
        div.appendChild(collabBadge);
      }
      
      if(isActive){
        const badge=document.createElement('div');
        badge.textContent='使用中';
        badge.style.color='#00FF00';
        badge.style.fontSize='0.7rem';
        badge.style.fontWeight='bold';
        badge.style.marginTop='3px';
        div.appendChild(badge);
      }
    }else{
      const lock=document.createElement('div');
      lock.textContent='🔒';
      lock.style.fontSize='2rem';
      div.appendChild(lock);
    }
    grid.appendChild(div);
  });
  document.getElementById('monsterModal').style.display='flex';
}

function closeMonsterModal(){
  document.getElementById('monsterModal').style.display='none';
  setTimeout(function(){
    if(!isLooping&&detector&&isCameraOn){
      isLooping=true;
      loop();
    }
  },100);
}

let faceMaskImage=null;
let faceMaskEnabled=false;
let faceMaskSize=150;
let bgEffectImage=null;
let bgEffectEnabled=false;
let bgEffectOpacity=0.7;

let currentEffectTab='mask';

function openEffects(){
  document.getElementById('effectsModal').style.display='flex';
  showEffectTab(currentEffectTab);
}

function closeEffectsModal(){
  document.getElementById('effectsModal').style.display='none';
  setTimeout(function(){
    if(!isLooping&&detector&&isCameraOn){
      isLooping=true;
      loop();
    }
  },100);
}

function showEffectTab(tab){
  currentEffectTab=tab;
  document.getElementById('maskTab').style.display=tab==='mask'?'block':'none';
  document.getElementById('bgTab').style.display=tab==='bg'?'block':'none';
  document.getElementById('tabMask').style.background=tab==='mask'?'#3b82f6':'rgba(255,255,255,0.2)';
  document.getElementById('tabBg').style.background=tab==='bg'?'#3b82f6':'rgba(255,255,255,0.2)';
}

function switchEffectTab(direction){
  const tabs=['mask','bg'];
  const idx=tabs.indexOf(currentEffectTab);
  const newIdx=(idx+direction+tabs.length)%tabs.length;
  showEffectTab(tabs[newIdx]);
}

function loadPresetMask(type){
  const urls={'pumpkin':'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/images/upscaled/PumpkinFace.png'};
  const img=new Image();
  img.crossOrigin='anonymous';
  img.onload=function(){
    faceMaskImage=img;
    const preview=document.getElementById('maskPreview');
    preview.innerHTML='';
    const previewImg=document.createElement('img');
    previewImg.src=urls[type];
    previewImg.style.width='100%';
    previewImg.style.height='100%';
    previewImg.style.objectFit='cover';
    preview.appendChild(previewImg);
    const toggle=document.getElementById('faceMaskToggle');
    toggle.checked=true;
    faceMaskEnabled=true;
    const slider=toggle.nextElementSibling;
    const circle=slider.nextElementSibling;
    slider.style.background='#22c55e';
    circle.style.transform='translateX(30px)';
    showMessage('マスクを選択しました');
  };
  img.src=urls[type];
}

function loadFaceMask(event){
  const file=event.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      faceMaskImage=img;
      const preview=document.getElementById('maskPreview');
      preview.innerHTML='';
      const previewImg=document.createElement('img');
      previewImg.src=e.target.result;
      previewImg.style.width='100%';
      previewImg.style.height='100%';
      previewImg.style.objectFit='cover';
      preview.appendChild(previewImg);
      showMessage('画像を読み込みました');
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

function updateMaskSize(value){
  faceMaskSize=parseInt(value);
  document.getElementById('maskSizeValue').textContent=value;
}

function toggleFaceMask(){
  const toggle=document.getElementById('faceMaskToggle');
  if(!faceMaskImage){
    showMessage('画像を選択してください');
    toggle.checked=false;
    return;
  }
  faceMaskEnabled=toggle.checked;
  const slider=toggle.nextElementSibling;
  const circle=slider.nextElementSibling;
  if(faceMaskEnabled){
    slider.style.background='#22c55e';
    circle.style.transform='translateX(30px)';
    showMessage('顔マスクON');
  }else{
    slider.style.background='#ccc';
    circle.style.transform='translateX(0)';
    showMessage('顔マスクOFF');
  }
}

function clearFaceMask(){
  faceMaskImage=null;
  faceMaskEnabled=false;
  const toggle=document.getElementById('faceMaskToggle');
  toggle.checked=false;
  const slider=toggle.nextElementSibling;
  const circle=slider.nextElementSibling;
  slider.style.background='#ccc';
  circle.style.transform='translateX(0)';
  const preview=document.getElementById('maskPreview');
  preview.innerHTML='<span style="color:#fff;font-size:0.9rem">画像なし</span>';
  showMessage('画像を削除しました');
}



function loadPresetBg(type){
  const colors={'green':'#00ff00','blue':'#0080ff'};
  const canvas=document.createElement('canvas');
  canvas.width=100;
  canvas.height=100;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle=colors[type]||'#00ff00';
  ctx.fillRect(0,0,100,100);
  const img=new Image();
  img.onload=function(){
    bgEffectImage=img;
    const preview=document.getElementById('bgPreview');
    preview.innerHTML='';
    preview.style.background=colors[type]||'#00ff00';
    const toggle=document.getElementById('bgEffectToggle');
    toggle.checked=true;
    bgEffectEnabled=true;
    const slider=toggle.nextElementSibling;
    const circle=slider.nextElementSibling;
    slider.style.background='#22c55e';
    circle.style.transform='translateX(30px)';
    showMessage('背景を選択しました');
  };
  img.src=canvas.toDataURL();
}

function loadBgEffect(event){
  const file=event.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      bgEffectImage=img;
      const preview=document.getElementById('bgPreview');
      preview.innerHTML='';
      const previewImg=document.createElement('img');
      previewImg.src=e.target.result;
      previewImg.style.width='100%';
      previewImg.style.height='100%';
      previewImg.style.objectFit='cover';
      preview.appendChild(previewImg);
      showMessage('画像を読み込みました');
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}



function toggleBgEffect(){
  const toggle=document.getElementById('bgEffectToggle');
  if(!bgEffectImage){
    showMessage('画像を選択してください');
    toggle.checked=false;
    return;
  }
  bgEffectEnabled=toggle.checked;
  const slider=toggle.nextElementSibling;
  const circle=slider.nextElementSibling;
  if(bgEffectEnabled){
    slider.style.background='#22c55e';
    circle.style.transform='translateX(30px)';
    showMessage('背景ON');
  }else{
    slider.style.background='#ccc';
    circle.style.transform='translateX(0)';
    showMessage('背景OFF');
  }
}

function updateBgOpacity(value){
  bgEffectOpacity=parseFloat(value);
  document.getElementById('bgOpacityValue').textContent=Math.round(value*100)+'%';
}

function clearBgEffect(){
  bgEffectImage=null;
  bgEffectEnabled=false;
  const toggle=document.getElementById('bgEffectToggle');
  toggle.checked=false;
  const slider=toggle.nextElementSibling;
  const circle=slider.nextElementSibling;
  slider.style.background='#ccc';
  circle.style.transform='translateX(0)';
  const preview=document.getElementById('bgPreview');
  preview.innerHTML='<span style="color:#fff;font-size:0.9rem">画像なし</span>';
  preview.style.background='rgba(255,255,255,0.1)';
  showMessage('画像を削除しました');
}

let bgmAudio=null;
let currentBGM='none';

function openBGMModal(){
  document.getElementById('bgmModal').style.display='flex';
}

function closeBGMModal(){
  document.getElementById('bgmModal').style.display='none';
  setTimeout(function(){
    if(!isLooping&&detector&&isCameraOn){
      isLooping=true;
      loop();
    }
  },100);
}

function setupMediaSession(){
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata=new MediaMetadata({
      title:'パンプキンナイト',
      artist:'AI筋トレRPG',
      album:'BGM',
      artwork:[{src:'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/images/ai-kintore-logo.png',sizes:'512x512',type:'image/png'}]
    });
    
    navigator.mediaSession.setActionHandler('play',()=>{
      if(bgmAudio)bgmAudio.play();
    });
    
    navigator.mediaSession.setActionHandler('pause',()=>{
      if(bgmAudio)bgmAudio.pause();
    });
  }
}

function initBGMAudio(){
  const oldAudio=document.getElementById('bgmAudioElement');
  if(oldAudio){
    oldAudio.pause();
    oldAudio.src='';
    oldAudio.load();
  }
  bgmAudio=oldAudio;
  currentBGM='none';
}

function toggleBGM(bgmName){
  const toggle=document.getElementById('pumpkinBGMToggle');
  const bgmToggleBtn=document.getElementById('bgmToggle');
  
  if(!bgmAudio){
    initBGMAudio();
  }
  
  if(bgmAudio&&currentBGM===bgmName&&!bgmAudio.paused){
    bgmAudio.pause();
    bgmAudio.currentTime=0;
    currentBGM='none';
    if(toggle){
      toggle.checked=false;
      const slider=toggle.nextElementSibling;
      const circle=slider.nextElementSibling;
      slider.style.background='#ccc';
      circle.style.transform='translateX(0)';
    }
    if(bgmToggleBtn){
      bgmToggleBtn.style.background='linear-gradient(135deg,#3b82f6,#60a5fa)';
    }
    return;
  }
  
  const bgmUrls={'pumpkin':'https://raw.githubusercontent.com/mameogalaxy/mameofactory/master/text-formatter-gas/sounds/pumpkin-knight.mp3'};
  if(bgmUrls[bgmName]&&bgmAudio){
    bgmAudio.pause();
    bgmAudio.src=bgmUrls[bgmName];
    bgmAudio.load();
    
    bgmAudio.play().then(()=>{
      currentBGM=bgmName;
      setupMediaSession();
      if(toggle){
        toggle.checked=true;
        const slider=toggle.nextElementSibling;
        const circle=slider.nextElementSibling;
        slider.style.background='#22c55e';
        circle.style.transform='translateX(30px)';
      }
      if(bgmToggleBtn){
        bgmToggleBtn.style.background='linear-gradient(135deg,#ff4757,#ff6b81)';
      }
    }).catch(e=>{
      console.log('BGM play error:',e);
      if(toggle)toggle.checked=false;
      alert('BGMを再生できませんでした。\nもう一度BGMボタンを押してください。');
    });
  }
}

let isCameraOn=true;

function showLoading(text){
  const overlay=document.getElementById('loadingOverlay');
  const loadingText=document.getElementById('loadingText');
  if(overlay)overlay.style.display='flex';
  if(loadingText)loadingText.textContent=text||'読み込み中...';
}

function hideLoading(){
  const overlay=document.getElementById('loadingOverlay');
  if(overlay)overlay.style.display='none';
}
function toggleCamera(){
  const video=document.getElementById('video');
  const overlay=document.getElementById('overlay');
  const btn=document.getElementById('cameraToggle');
  if(!btn)return;
  if(isCameraOn){
    isLooping=false;
    const stream=video.srcObject;
    if(stream){
      stream.getTracks().forEach(track=>track.stop());
      video.srcObject=null;
    }
    video.style.display='none';
    overlay.style.display='none';
    const ctx=overlay.getContext('2d');
    if(ctx)ctx.clearRect(0,0,overlay.width,overlay.height);
    isCameraOn=false;
    btn.style.background='linear-gradient(135deg,#3b82f6,#60a5fa)';
  }else{
    isCameraOn=true;
    btn.style.background='linear-gradient(135deg,#ff4757,#ff6b81)';
    video.style.display='block';
    overlay.style.display='block';
    faceDetected=false;
    setupCameraAndModel();
  }
}

function openHowToPlay(){
  document.getElementById('howToPlayModal').style.display='block';
  document.body.style.overflow='hidden';
}

function closeHowToPlay(){
  document.getElementById('howToPlayModal').style.display='none';
  document.body.style.overflow='auto';
}

function checkDateChange(){
  const today=new Date().toDateString();
  const savedDate=localStorage.getItem('lastDate');
  if(today!==savedDate){
    dailyTotal=0;
    lastDate=today;
    localStorage.setItem('dailyTotal',0);
    localStorage.setItem('lastDate',today);
    updateUI();
  }
}

function updatePlayTime(){
  if(!playStartTime)return;
  const elapsed=Math.floor((Date.now()-playStartTime)/1000);
  const mins=Math.floor(elapsed/60);
  const secs=elapsed%60;
  document.getElementById('playTime').textContent=mins.toString().padStart(2,'0')+':'+secs.toString().padStart(2,'0');
}

setInterval(checkDateChange,60000);

let missions={login:{completed:false,claimed:false},plays:{completed:false,claimed:false,current:0,target:100},time:{completed:false,claimed:false,current:0,target:600}};

function loadMissions(){const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';if(!isLoggedIn){missions={login:{completed:true,claimed:false},plays:{completed:false,claimed:false,current:0,target:100},time:{completed:false,claimed:false,current:0,target:600}};return;}const loginClaimed=localStorage.getItem('loginClaimed')==='true';const playsClaimed=localStorage.getItem('playsClaimed')==='true';const timeClaimed=localStorage.getItem('timeClaimed')==='true';missions={login:{completed:true,claimed:loginClaimed},plays:{completed:false,claimed:playsClaimed,current:0,target:100},time:{completed:false,claimed:timeClaimed,current:0,target:600}};}

function saveMissions(){const username=localStorage.getItem('username')||'guest';localStorage.setItem('missions_'+username,JSON.stringify(missions));}

function updateMissionProgress(){missions.plays.current=dailyTotal;if(dailyTotal>=missions.plays.target)missions.plays.completed=true;const playTime=playStartTime?Math.floor((Date.now()-playStartTime)/1000):0;missions.time.current=playTime;if(playTime>=missions.time.target)missions.time.completed=true;saveMissions();}

function openMissions(){const isLoggedIn=localStorage.getItem('isLoggedIn')==='true';if(!isLoggedIn){showMessage('ログインが必要です');return;}updateMissionProgress();const list=document.getElementById('missionList');list.innerHTML='';const types={login:{name:'ログイン',reward:'ブロンズ×3'},plays:{name:'100回プレイ',reward:'シルバー×1'},time:{name:'10分プレイ',reward:'ゴールド×1'}};for(let key in missions){const m=missions[key];const t=types[key];const progress=m.current?`(${m.current}/${m.target})`:'';const status=m.claimed?'受取済':m.completed?'受取可能':'未達成';const div=document.createElement('div');div.style.background='rgba(255,255,255,0.1)';div.style.padding='15px';div.style.borderRadius='10px';div.style.border='2px solid '+(m.claimed?'#666':m.completed?'#10b981':'#999');div.innerHTML=`<div style="color:#fff;font-size:1.1rem;font-weight:bold;margin-bottom:5px">${t.name} ${progress}</div><div style="color:#fbbf24;font-size:0.9rem;margin-bottom:10px">報酬: ${t.reward}</div><div style="color:#fff;font-size:0.9rem">状態: ${status}</div>`;if(m.completed&&!m.claimed){const btn=document.createElement('button');btn.textContent='受け取る';btn.style.width='100%';btn.style.padding='10px';btn.style.background='#10b981';btn.style.color='#fff';btn.style.border='none';btn.style.borderRadius='8px';btn.style.cursor='pointer';btn.style.fontSize='1rem';btn.style.fontWeight='bold';btn.style.marginTop='10px';btn.onclick=()=>claimMission(key);div.appendChild(btn);}list.appendChild(div);}document.getElementById('missionModal').style.display='flex';}

function claimMission(type){if(!missions[type].completed||missions[type].claimed)return;const username=localStorage.getItem('username')||'guest';const email=localStorage.getItem('userEmail');missions[type].claimed=true;localStorage.setItem(type+'Claimed','true');const rewards={login:{bronze:3},plays:{silver:1},time:{gold:1}};const reward=rewards[type];for(let key in reward){let count=parseInt(localStorage.getItem(key+'TreasureCount_'+username)||'0');count+=reward[key];localStorage.setItem(key+'TreasureCount_'+username,count);}showLoading('報酬受取中...');google.script.run.withSuccessHandler(function(){hideLoading();showMessage('報酬を獲得しました！');openMissions();}).withFailureHandler(function(){hideLoading();showMessage('報酬を獲得しました！');openMissions();}).saveMissionClaim(email,type);}

function closeMissionModal(){document.getElementById('missionModal').style.display='none';setTimeout(function(){if(!isLooping&&detector&&isCameraOn){isLooping=true;loop();}},100);}

loadMissions();

window.addEventListener('pageshow',function(event){
  if(event.persisted){
    initBGMAudio();
  }
});

function showSharePreview(){
  const canvas=generateResultImage();
  const previewCanvas=document.getElementById('sharePreviewCanvas');
  previewCanvas.width=canvas.width;
  previewCanvas.height=canvas.height;
  const ctx=previewCanvas.getContext('2d');
  ctx.drawImage(canvas,0,0);
  
  const stage=currentStage;
  const squats=totalSquats;
  const pattern=document.getElementById('sharePattern').value;
  let text='';
  if(pattern==='1'){
    text='\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3084\u3063\u305f\u3089\n\u30b9\u30c6\u30fc\u30b8'+stage+'\u307e\u3067\u884c\u3051\u305f\ud83d\udd25\n\u660e\u65e5\u306e\u81ea\u5206\u304c\u697d\u3057\u307f\n#AI\u7b4b\u30c8\u30ecRPG';
  }else if(pattern==='2'){
    text='\u30b9\u30c6\u30fc\u30b8'+stage+'\u3067\u8db3\u304c\u9650\u754c\ud83d\ude02\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de...\u307e\u3060\u3044\u3051\u308b\uff01\n#AI\u7b4b\u30c8\u30ecRPG';
  }else{
    text='\u3010\u901f\u5831\u3011\u30b9\u30c6\u30fc\u30b8'+stage+'\u30af\u30ea\u30a2\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3067\u6483\u7834\ud83c\udfae\n\u3053\u306e\u30b2\u30fc\u30e0\u3001\u7b4b\u8089\u75db\u4e0d\u53ef\u907f\n#AI\u7b4b\u30c8\u30ecRPG';
  }
  document.getElementById('sharePreviewText').textContent=text;
  document.getElementById('sharePreviewModal').style.display='flex';
}

function closeSharePreview(){
  document.getElementById('sharePreviewModal').style.display='none';
}

async function executeShare(){
  await shareToXWithImage();
  closeSharePreview();
}

function showXSharePreview(){
  const canvas=generateResultImage();
  const previewCanvas=document.getElementById('xSharePreviewCanvas');
  previewCanvas.width=canvas.width;
  previewCanvas.height=canvas.height;
  const ctx=previewCanvas.getContext('2d');
  ctx.drawImage(canvas,0,0);
  
  const stage=currentStage;
  const squats=totalSquats;
  const pattern=document.getElementById('sharePattern').value;
  let text='';
  if(pattern==='1'){
    text='\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3084\u3063\u305f\u3089\n\u30b9\u30c6\u30fc\u30b8'+stage+'\u307e\u3067\u884c\u3051\u305f\ud83d\udd25\n\u660e\u65e5\u306e\u81ea\u5206\u304c\u697d\u3057\u307f\n#AI\u7b4b\u30c8\u30ecRPG';
  }else if(pattern==='2'){
    text='\u30b9\u30c6\u30fc\u30b8'+stage+'\u3067\u8db3\u304c\u9650\u754c\ud83d\ude02\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de...\u307e\u3060\u3044\u3051\u308b\uff01\n#AI\u7b4b\u30c8\u30ecRPG';
  }else{
    text='\u3010\u901f\u5831\u3011\u30b9\u30c6\u30fc\u30b8'+stage+'\u30af\u30ea\u30a2\n\u30b9\u30af\u30ef\u30c3\u30c8'+squats+'\u56de\u3067\u6483\u7834\ud83c\udfae\n\u3053\u306e\u30b2\u30fc\u30e0\u3001\u7b4b\u8089\u75db\u4e0d\u53ef\u907f\n#AI\u7b4b\u30c8\u30ecRPG';
  }
  document.getElementById('xSharePreviewText').textContent=text;
  document.getElementById('xSharePreviewModal').style.display='flex';
}

function closeXSharePreview(){
  document.getElementById('xSharePreviewModal').style.display='none';
}

function executeXShare(){
  shareToX();
  const username=localStorage.getItem('username')||'guest';
  let count=parseInt(localStorage.getItem('silverTreasureCount_'+username)||'0');
  count++;
  localStorage.setItem('silverTreasureCount_'+username,count);
  showMessage('\u30b7\u30eb\u30d0\u30fc\u5b9d\u7bb1\u3092\u7372\u5f97\uff01');
  closeXSharePreview();
}

if(navigator.share){
  console.log('Web Share API supported');
}
</script>
