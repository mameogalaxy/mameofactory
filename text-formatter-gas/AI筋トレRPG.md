# AI筋トレRPG 開発プロンプト

**場所**: `C:\my-website\text-formatter-gas\`
**GASプロジェクトID**: `1SFbDg5JMmeMVFUFQW7t63EfHwRLugCcR_uokqYNQ2DpVspbQE6QGneji`
**デプロイID**: `AKfycbxdoZQLIAYodBf3tLnIkD9yR-I1eAhBlj33zK9Oe7EV6uk3OYeAs4HOyFIidWhOtsHd`
**スプレッドシートID**: `180zH4Ba5OTXMCN5abNQQsICWACn6IKTNQ0q8Wo8jmuc`

## デプロイコマンド
```bash
cd C:\my-website\text-formatter-gas
clasp push
```

## 主要機能
- **姿勢検出**: TensorFlow.js + MoveNet
- **レベルシステム**: 最大Lv.100、経験値 `10 × 1.5^(レベル-1)`
- **ダメージシステム**: 基本ダメージ(1-3) + (レベル-1)
- **モンスター図鑑**: 7種類（スライム、パンプキング、トララレロなど）
- **ガチャシステム**: レア率厳しめ（ブロンズ0.5%、シルバー3%、ゴールド15%）
- **宝箱ドロップ**: `10 + (ステージ数 × 2)%`（最大90%）
- **顔マスク機能**: プリセット選択、カスタムアップロード、サイズ調整

## ファイル構成
```
C:\my-website\text-formatter-gas\
├── game.html          # メインページ
├── script.html        # ゲームロジック
├── body.html          # UI構造
├── styles.html        # CSS
├── Code.js            # GASメイン処理
├── UserData.js        # ユーザーデータ管理
├── images\
│   ├── original\      # 元画像
│   └── upscaled\      # 高解像度版（4倍）
└── upscale_pumpkin.py # アップスケールスクリプト
```

## 最近の修正（2025年1月14日）
- **Xシェア機能追加**: 専用シェアボタン、プレビュー表示、シルバー宝箱報酬
- **シェアパターン改善**: モチベーション型、リアル実況型、ユーモア型
- **ガチャ確率調整**: レア排出率を大幅に厳しく（価値向上）
- **SNSシェア報酬**: Xシェアでシルバー宝箱×1獲得

## SNSシェア機能
### ボタン構成
1. **スコア保存**: スプレッドシートに記録
2. **SNSにシェア**: Web Share API（画像付き、複数SNS選択可能）
3. **Xにシェア**: X専用プレビュー → テキスト投稿 + シルバー宝箱×1

### シェアパターン
- **モチベーション型**: 「スクワット○回やったら ステージ○まで行けた🔥 明日の自分が楽しみ」
- **リアル実況型**: 「ステージ○で足が限界😂 スクワット○回...まだいける！」
- **ユーモア型**: 「【速報】ステージ○クリア スクワット○回で撃破🎮 このゲーム、筋肉痛不可避」

## ガチャ排出率
| 宝箱 | レアモンスター | ノーマルモンスター | はずれ |
|------|----------------|-------------------|--------|
| ブロンズ | 0.5% | 10% | 90% |
| シルバー | 3% | 17% | 80% |
| ゴールド | 15% | 35% | 50% |

## モンスター追加手順
1. 画像を `images\original\モンスターID.png` に保存
2. `upscale_pumpkin.py` でアップスケール
3. GitHubにプッシュ
4. `monsterTypes`配列に追加
5. `drawMonster`関数に描画処理追加
6. `clasp push`

## トラブルシューティング
- **カメラフリーズ**: 全ポップアップ排除済み、モーダル閉じる時に100ms待機
- **画像が表示されない**: RAW URLを確認、キャッシュクリア
- **修正が反映されない**: `clasp push`後に数分待機、スーパーリロード

## 重要な注意点
- 修正したら必ず`clasp push`でデプロイ
- 画像はGitHubのRAW URLを使用
- アップスケールは4倍（LANCZOS補間）
- モンスター名は視認性のため白文字+黒縁取り

## 歩数計機能について（検討中）
### 技術的制限
- **Webアプリ**: バックグラウンド動作不可、アプリ起動中のみカウント可能
- **ネイティブアプリ**: HealthKit/Google Fit連携で24時間カウント可能

### ネイティブアプリ化（Capacitor）
- 既存コードをそのまま使用可能
- GASもそのまま使える
- 配信: App Store（12,980円/年）+ Google Play（2,500円/初回）
- 開発期間: 1-2週間

### 運用方針
- **サーバー側（GAS）**: `clasp push`で即反映（ガチャ確率、ランキング等）
- **アプリ側**: 審査必要（新機能、UI変更等）
- 動的コンテンツをGAS管理で、アプリ更新頻度を削減

## デイリーミッション自動リセット

### 設定方法
1. GASエディタで `setupDailyTrigger()` を実行
2. 毎日午前0時に自動的にミッションがリセットされます

### 機能
- 全ユーザーのミッション日付をチェック
- 日付が変わったユーザーのミッションをリセット
- ログインミッション、プレイミッション、タイムミッションを全てfalseに

### テスト方法
```javascript
testDailyReset() // 手動でリセットをテスト
```

### トリガー管理
- `setupDailyTrigger()`: トリガーを設定
- `deleteDailyTriggers()`: トリガーを削除

## 開発履歴

### 2025年1月15日 - デイリーミッション自動リセット実装
#### 新機能
- GASトリガーで毎日午前0時に自動実行
- 全ユーザーのミッションを一括リセット
- ロック機構で同時実行を防止

#### ファイル追加
- `DailyMissionReset.js`: 自動リセット処理

### 2025年1月15日 - 背景エフェクト機能追加
#### 新機能
- 背景画像を適用できる機能を実装
- プリセット背景（オフィス、自然）
- カスタム画像アップロード対応
- 不透明度調整（0-100%）
- ON/OFF切り替え機能

#### UI改善
- 「背景」ボタンをコントロールパネルに追加
- 顔マスクと同様のUIデザイン
- プレビュー表示機能

#### 技術的実装
- Canvas APIで背景画像を描画
- globalAlphaで不透明度制御
- 顔マスクと独立して動作

### 2025年1月15日 - BGMトグルスイッチ修正
#### バグ修正
- BGMモーダルのトグルスイッチスタイルを修正
- トグルスイッチの背景色が正しく表示されるように改善
- ON/OFF状態の視覚的フィードバックを改善
- 不要なCSS（#toggleBg、#pumpkinBGMToggle:checked）を削除

#### 技術的改善
- トグルスイッチのスタイルをインラインで直接指定
- JavaScriptでスタイルを動的に変更する方式に統一
- コードの可読性と保守性を向上

### 2025年1月11日 - BGM機能追加・UI改善
#### BGM機能実装
- パンプキンナイトBGM追加（ループ再生対応）
- BGMボタンUI統一（カメラボタンと同じデザイン）
- 選択中のBGMを視覚的に表示（緑色 + "ON"表示）
- スマホ対応（自動再生ポリシー対策）

#### ゲームバランス調整
- ステージ5の敵をスケルトン→パンプキンナイトに変更

#### BGM追加手順
1. 音源ファイルを `sounds/` に配置
2. GitHubにアップロード
3. `script.html`の`bgmUrls`に追加
4. `body.html`にボタン追加
5. `clasp push`

#### 技術的改善
- ユーザー操作後にBGM再生（ブラウザ制限対応）
- ボタンフィードバック実装（選択状態の可視化）
- ループ再生の自動化

### 2025年1月14日 - SNSシェア機能追加
#### Xシェア機能
- X専用シェアボタン追加
- プレビューモーダル実装（画像・テキスト確認）
- シルバー宝箱×1報酬追加
- 画像手動添付の案内表示

#### シェアパターン改善
- ビフォーアフター型 → モチベーション型
- 実況型 → リアル実況型
- ゲーム実況風 → ユーモア型

#### ガチャバランス調整
- レア排出率を大幅に厳しく調整
  - ブロンズ: 1% → 0.5%
  - シルバー: 10% → 3%
  - ゴールド: 50% → 15%
- ノーマル排出率も調整
  - ブロンズ: 20% → 10%
  - シルバー: 40% → 17%
  - ゴールド: 30% → 35%

#### バグ修正
- Xシェア時の重複報酬付与を修正
- shareToX関数から報酬処理を削除
- executeXShare関数で一元管理

#### 歩数計機能の調査
- Webアプリの技術的制限を確認
- ネイティブアプリ化（Capacitor）の検討
- HealthKit/Google Fit連携の実装方法を調査
